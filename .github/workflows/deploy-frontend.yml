# =============================================================================
# Workflow Automatizado para Despliegue de Frontend
# =============================================================================
# Este workflow automatiza completamente el proceso de build y deploy del frontend
# Se ejecuta automÃ¡ticamente en pushes a main o manualmente

name: Deploy Frontend

on:
  # Trigger automÃ¡tico en pushes a main que modifiquen el frontend
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend.yml'
  
  # Trigger manual para deploys on-demand
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente de despliegue'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      force_rebuild:
        description: 'Forzar rebuild completo (ignora cachÃ©)'
        required: false
        default: false
        type: boolean
      skip_tests:
        description: 'Saltar tests (solo para desarrollo)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  id-token: write

env:
  # ConfiguraciÃ³n AWS para regiÃ³n de MÃ©xico
  AWS_REGION: mx-central-1
  AWS_DEFAULT_REGION: mx-central-1
  
  # ConfiguraciÃ³n de Node.js
  NODE_VERSION: '18'
  
  # ConfiguraciÃ³n de cachÃ©
  CACHE_VERSION: v1

jobs:
  # =============================================================================
  # Job de VerificaciÃ³n y PreparaciÃ³n
  # =============================================================================
  prepare:
    name: ðŸ” Preparar y Verificar
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.setup.outputs.environment }}
      should_deploy: ${{ steps.changes.outputs.should_deploy }}
      cache_key: ${{ steps.setup.outputs.cache_key }}
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: âš™ï¸ Configurar ambiente
        id: setup
        run: |
          # Determinar ambiente
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENVIRONMENT="${{ inputs.environment }}"
          else
            ENVIRONMENT="dev"
          fi
          
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "cache_key=frontend-${{ env.CACHE_VERSION }}-${{ hashFiles('frontend/package-lock.json') }}" >> $GITHUB_OUTPUT
          
          echo "ðŸ·ï¸ Ambiente seleccionado: $ENVIRONMENT"
      
      - name: ðŸ” Detectar cambios
        id: changes
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… Deploy manual solicitado"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            # Verificar si hay cambios en el frontend
            if git diff --name-only HEAD^ HEAD | grep -E '^frontend/' > /dev/null; then
              echo "should_deploy=true" >> $GITHUB_OUTPUT
              echo "âœ… Cambios detectados en frontend"
            else
              echo "should_deploy=false" >> $GITHUB_OUTPUT
              echo "â­ï¸ Sin cambios en frontend"
            fi
          fi

  # =============================================================================
  # Job de Build y Test
  # =============================================================================
  build-and-test:
    name: ðŸ”¨ Build y Test
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.should_deploy == 'true'
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
      
      - name: ðŸ“‹ Mostrar informaciÃ³n del ambiente
        run: |
          echo "ðŸ”§ InformaciÃ³n del Build:"
          echo "Node.js: $(node --version)"
          echo "npm: $(npm --version)"
          echo "Ambiente: ${{ needs.prepare.outputs.environment }}"
          echo "Directorio: $(pwd)"
      
      - name: ðŸ“¦ Instalar dependencias
        working-directory: ./frontend
        run: |
          echo "ðŸ“¦ Instalando dependencias..."
          npm ci --prefer-offline --no-audit
          
          echo "ðŸ“Š InformaciÃ³n de dependencias:"
          npm list --depth=0
      
      - name: ðŸ§ª Ejecutar tests
        if: inputs.skip_tests != true
        working-directory: ./frontend
        run: |
          echo "ðŸ§ª Ejecutando tests..."
          npm test -- --coverage --watchAll=false --passWithNoTests
      
      - name: ðŸ” Lint y verificaciones
        working-directory: ./frontend
        run: |
          echo "ðŸ” Verificando cÃ³digo..."
          # Si existe ESLint, ejecutarlo
          if npm list eslint &>/dev/null; then
            npm run lint --if-present || echo "âš ï¸ ESLint no configurado"
          fi
          
          # Verificar TypeScript si estÃ¡ configurado
          if [ -f "tsconfig.json" ]; then
            echo "ðŸ” Verificando TypeScript..."
            npx tsc --noEmit || echo "âš ï¸ TypeScript check fallÃ³"
          fi
      
      - name: ðŸ—ï¸ Build aplicaciÃ³n
        working-directory: ./frontend
        env:
          CI: true
          GENERATE_SOURCEMAP: false
          NODE_ENV: production
        run: |
          echo "ðŸ—ï¸ Construyendo aplicaciÃ³n..."
          npm run build
          
          echo "ðŸ“Š InformaciÃ³n del build:"
          du -sh build/
          ls -la build/
          
          # Verificar archivos crÃ­ticos
          if [ ! -f "build/index.html" ]; then
            echo "âŒ Error: index.html no encontrado"
            exit 1
          fi
          
          echo "âœ… Build completado exitosamente"
      
      - name: ðŸ“¤ Subir artefactos de build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ needs.prepare.outputs.environment }}
          path: frontend/build/
          retention-days: 7

  # =============================================================================
  # Job de Despliegue
  # =============================================================================
  deploy:
    name: ðŸš€ Desplegar a AWS
    runs-on: ubuntu-latest
    needs: [prepare, build-and-test]
    if: needs.prepare.outputs.should_deploy == 'true'
    environment: ${{ needs.prepare.outputs.environment }}
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ“¤ Descargar artefactos de build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ needs.prepare.outputs.environment }}
          path: frontend/build/
      
      - name: âš™ï¸ Configurar AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-FrontendDeploy
      
      - name: âœ… Verificar conexiÃ³n AWS
        run: |
          echo "ðŸ” Verificando conexiÃ³n a AWS..."
          aws sts get-caller-identity
          echo "ðŸŒ RegiÃ³n activa: $(aws configure get region)"
      
      - name: ðŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest
          terraform_wrapper: false
      
      - name: ðŸ“Š Obtener informaciÃ³n de infraestructura
        id: infra
        working-directory: ./terraform/environments/${{ needs.prepare.outputs.environment }}
        run: |
          echo "ðŸ“‹ Obteniendo informaciÃ³n de la infraestructura..."
          
          # Inicializar Terraform
          terraform init -backend-config="bucket=${{ secrets.TERRAFORM_STATE_BUCKET }}"
          
          # Obtener outputs
          S3_BUCKET=$(terraform output -raw frontend_bucket_name)
          CLOUDFRONT_ID=$(terraform output -raw frontend_cloudfront_distribution_id)
          API_URL=$(terraform output -raw api_gateway_url)
          FRONTEND_URL=$(terraform output -raw frontend_url)
          
          echo "s3_bucket=$S3_BUCKET" >> $GITHUB_OUTPUT
          echo "cloudfront_id=$CLOUDFRONT_ID" >> $GITHUB_OUTPUT
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          
          echo "âœ… InformaciÃ³n obtenida:"
          echo "  ðŸ“¦ S3 Bucket: $S3_BUCKET"
          echo "  ðŸ“¡ CloudFront ID: $CLOUDFRONT_ID"
          echo "  ðŸŒ Frontend URL: $FRONTEND_URL"
          echo "  ðŸ”— API URL: $API_URL"
      
      - name: ðŸ“ Configurar variables de entorno para build
        working-directory: ./frontend
        run: |
          echo "ðŸ“ Configurando .env.production..."
          cat > .env.production << EOF
          REACT_APP_API_URL=${{ steps.infra.outputs.api_url }}
          REACT_APP_ENVIRONMENT=${{ needs.prepare.outputs.environment }}
          REACT_APP_FRONTEND_URL=${{ steps.infra.outputs.frontend_url }}
          GENERATE_SOURCEMAP=false
          PUBLIC_URL=/
          EOF
          
          echo "âœ… Variables configuradas:"
          cat .env.production
      
      - name: â˜ï¸ Sincronizar con S3
        run: |
          echo "â˜ï¸ Subiendo archivos a S3..."
          
          # Sincronizar archivos con headers optimizados
          aws s3 sync frontend/build/ s3://${{ steps.infra.outputs.s3_bucket }}/ \
            --delete \
            --exact-timestamps \
            --metadata-directive REPLACE \
            --cache-control "public,max-age=31536000,immutable" \
            --exclude "*.html" \
            --exclude "*.json"
          
          # Subir archivos HTML con cache corto
          aws s3 sync frontend/build/ s3://${{ steps.infra.outputs.s3_bucket }}/ \
            --exclude "*" \
            --include "*.html" \
            --include "*.json" \
            --metadata-directive REPLACE \
            --cache-control "public,max-age=0,must-revalidate"
          
          echo "âœ… Archivos sincronizados con S3"
      
      - name: ðŸ”„ Invalidar cachÃ© de CloudFront
        id: invalidation
        run: |
          echo "ðŸ”„ Invalidando cachÃ© de CloudFront..."
          
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ steps.infra.outputs.cloudfront_id }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          
          echo "invalidation_id=$INVALIDATION_ID" >> $GITHUB_OUTPUT
          echo "âœ… InvalidaciÃ³n iniciada: $INVALIDATION_ID"
      
      - name: â³ Esperar invalidaciÃ³n (opcional)
        if: needs.prepare.outputs.environment == 'prod'
        run: |
          echo "â³ Esperando que complete la invalidaciÃ³n..."
          aws cloudfront wait invalidation-completed \
            --distribution-id ${{ steps.infra.outputs.cloudfront_id }} \
            --id ${{ steps.invalidation.outputs.invalidation_id }}
          echo "âœ… InvalidaciÃ³n completada"
      
      - name: ðŸ§ª Verificar despliegue
        run: |
          echo "ðŸ§ª Verificando despliegue..."
          
          # Esperar un poco para propagaciÃ³n
          sleep 30
          
          # Verificar que el sitio responde
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.infra.outputs.frontend_url }}" || echo "000")
          
          if [[ "$HTTP_STATUS" == "200" ]]; then
            echo "âœ… Sitio respondiendo correctamente (HTTP $HTTP_STATUS)"
          else
            echo "âš ï¸ Sitio respondiÃ³ con HTTP $HTTP_STATUS"
          fi
      
      - name: ðŸ“Š Mostrar resumen del despliegue
        run: |
          echo "ðŸŽ‰ Â¡DESPLIEGUE COMPLETADO!"
          echo "========================="
          echo ""
          echo "ðŸ“Š InformaciÃ³n del Despliegue:"
          echo "ðŸ·ï¸  Ambiente: ${{ needs.prepare.outputs.environment }}"
          echo "ðŸŒ Frontend URL: ${{ steps.infra.outputs.frontend_url }}"
          echo "ðŸ”— API URL: ${{ steps.infra.outputs.api_url }}"
          echo "ðŸ“¦ S3 Bucket: ${{ steps.infra.outputs.s3_bucket }}"
          echo "ðŸ“¡ CloudFront ID: ${{ steps.infra.outputs.cloudfront_id }}"
          echo "ðŸ”„ InvalidaciÃ³n ID: ${{ steps.invalidation.outputs.invalidation_id }}"
          echo ""
          echo "ðŸ”— Links Ãštiles:"
          echo "â€¢ Frontend: ${{ steps.infra.outputs.frontend_url }}"
          echo "â€¢ API: ${{ steps.infra.outputs.api_url }}"
          echo "â€¢ CloudFront Console: https://console.aws.amazon.com/cloudfront/home#/distributions/${{ steps.infra.outputs.cloudfront_id }}"
          echo "â€¢ S3 Console: https://s3.console.aws.amazon.com/s3/buckets/${{ steps.infra.outputs.s3_bucket }}"

  # =============================================================================
  # Job de Notificaciones (opcional)
  # =============================================================================
  notify:
    name: ðŸ“¢ Notificar Resultado
    runs-on: ubuntu-latest
    needs: [prepare, build-and-test, deploy]
    if: always() && needs.prepare.outputs.should_deploy == 'true'
    
    steps:
      - name: ðŸ“¢ Resultado del despliegue
        run: |
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "ðŸŽ‰ Â¡Despliegue exitoso!"
            echo "estado=success" >> $GITHUB_ENV
            echo "emoji=ðŸŽ‰" >> $GITHUB_ENV
            echo "mensaje=Despliegue completado exitosamente" >> $GITHUB_ENV
          else
            echo "âŒ Despliegue fallÃ³"
            echo "estado=failure" >> $GITHUB_ENV
            echo "emoji=âŒ" >> $GITHUB_ENV  
            echo "mensaje=El despliegue fallÃ³" >> $GITHUB_ENV
          fi
          
          echo "ðŸ“Š Resumen de Jobs:"
          echo "â€¢ PreparaciÃ³n: ${{ needs.prepare.result }}"
          echo "â€¢ Build y Test: ${{ needs.build-and-test.result }}"
          echo "â€¢ Despliegue: ${{ needs.deploy.result }}"
      
      # AquÃ­ puedes agregar integraciones con Slack, Discord, etc.
      - name: ðŸ’¬ Comentar en PR (si aplica)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const estado = process.env.estado;
            const emoji = process.env.emoji;
            const mensaje = process.env.mensaje;
            
            const comment = `${emoji} **Frontend Deploy - ${estado.toUpperCase()}**
            
            **Ambiente:** ${{ needs.prepare.outputs.environment }}
            **Estado:** ${mensaje}
            
            ${estado === 'success' ? 'ðŸ”— **Links:**' : ''}
            ${estado === 'success' ? 'â€¢ [Ver Frontend](URL_WILL_BE_ADDED)' : ''}
            ${estado === 'success' ? 'â€¢ [Ver API](URL_WILL_BE_ADDED)' : ''}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
