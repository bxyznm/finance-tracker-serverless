# =============================================================================
# Workflow Automatizado para Despliegue de Frontend
# =============================================================================
# Este workflow automatiza completamente el proceso de build y deploy del frontend
# Se ejecuta automÃ¡ticamente en pushes a main o manualmente

name: Deploy Frontend

on:
  # Trigger automÃ¡tico en pushes a main que modifiquen el frontend
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend.yml'
  
  # Trigger manual para deploys on-demand
  workflow_dispatch:
    inputs:
      action:
        description: 'AcciÃ³n a realizar'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - destroy
      environment:
        description: 'Ambiente de despliegue'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      force_rebuild:
        description: 'Forzar rebuild completo (ignora cachÃ©)'
        required: false
        default: false
        type: boolean
      skip_tests:
        description: 'Saltar tests (solo para desarrollo)'
        required: false
        default: false
        type: boolean
      confirm_destroy:
        description: 'âš ï¸ CONFIRMAR DESTRUCCIÃ“N (escribir "DESTROY" para confirmar)'
        required: false
        default: ''
        type: string

permissions:
  contents: read
  id-token: write

env:
  # ConfiguraciÃ³n AWS para regiÃ³n de MÃ©xico
  AWS_REGION: mx-central-1
  AWS_DEFAULT_REGION: mx-central-1
  
  # ConfiguraciÃ³n de Node.js
  NODE_VERSION: '18'
  
  # ConfiguraciÃ³n de cachÃ©
  CACHE_VERSION: v1

jobs:
  # =============================================================================
  # Job de VerificaciÃ³n y PreparaciÃ³n
  # =============================================================================
  prepare:
    name: ğŸ” Preparar y Verificar
    runs-on: ubuntu-latest
    if: github.event.inputs.action != 'destroy' || github.event.inputs.action == null
    outputs:
      environment: ${{ steps.setup.outputs.environment }}
      should_deploy: ${{ steps.changes.outputs.should_deploy }}
      cache_key: ${{ steps.setup.outputs.cache_key }}
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: âš™ï¸ Configurar ambiente
        id: setup
        run: |
          # Determinar ambiente
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENVIRONMENT="${{ inputs.environment }}"
          else
            ENVIRONMENT="dev"
          fi
          
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "cache_key=frontend-${{ env.CACHE_VERSION }}-${{ hashFiles('frontend/package-lock.json') }}" >> $GITHUB_OUTPUT
          
          echo "ğŸ·ï¸ Ambiente seleccionado: $ENVIRONMENT"
      
      - name: ğŸ” Detectar cambios
        id: changes
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… Deploy manual solicitado"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            # Verificar si hay cambios en el frontend
            if git diff --name-only HEAD^ HEAD | grep -E '^frontend/' > /dev/null; then
              echo "should_deploy=true" >> $GITHUB_OUTPUT
              echo "âœ… Cambios detectados en frontend"
            else
              echo "should_deploy=false" >> $GITHUB_OUTPUT
              echo "â­ï¸ Sin cambios en frontend"
            fi
          fi

  # =============================================================================
  # Job de Build y Test
  # =============================================================================
  build-and-test:
    name: ğŸ”¨ Build y Test
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.should_deploy == 'true' && (github.event.inputs.action != 'destroy' || github.event.inputs.action == null)
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org/'
      
      - name: ğŸ”§ Configurar cachÃ© npm
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            frontend/node_modules
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('frontend/package-lock.json', 'frontend/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ env.NODE_VERSION }}-
            ${{ runner.os }}-node-
      
      - name: ğŸ“‹ Mostrar informaciÃ³n del ambiente
        run: |
          echo "ğŸ”§ InformaciÃ³n del Build:"
          echo "Node.js: $(node --version)"
          echo "npm: $(npm --version)"
          echo "Ambiente: ${{ needs.prepare.outputs.environment }}"
          echo "Directorio: $(pwd)"
      
      - name: ğŸ“¦ Instalar dependencias
        working-directory: ./frontend
        run: |
          echo "ğŸ“¦ Instalando dependencias..."
          echo "Node: $(node --version), npm: $(npm --version)"
          
          # Limpiar cachÃ© npm si es necesario
          npm cache clean --force || true
          
          # Instalar dependencias
          if [[ -f "package-lock.json" ]]; then
            npm ci --prefer-offline --no-audit
          else
            npm install --prefer-offline --no-audit
          fi
          
          echo "ğŸ“Š InformaciÃ³n de dependencias:"
          npm list --depth=0 || true
      
      - name: ğŸ§ª Ejecutar tests
        if: inputs.skip_tests != true
        working-directory: ./frontend
        run: |
          echo "ğŸ§ª Ejecutando tests..."
          npm test -- --coverage --watchAll=false --passWithNoTests
      
      - name: ğŸ” Lint y verificaciones
        working-directory: ./frontend
        run: |
          echo "ğŸ” Verificando cÃ³digo..."
          # Si existe ESLint, ejecutarlo
          if npm list eslint &>/dev/null; then
            npm run lint --if-present || echo "âš ï¸ ESLint no configurado"
          fi
          
          # Verificar TypeScript si estÃ¡ configurado
          if [ -f "tsconfig.json" ]; then
            echo "ğŸ” Verificando TypeScript..."
            npx tsc --noEmit || echo "âš ï¸ TypeScript check fallÃ³"
          fi
      
      - name: ğŸ—ï¸ Build aplicaciÃ³n
        working-directory: ./frontend
        env:
          CI: true
          GENERATE_SOURCEMAP: false
          NODE_ENV: production
        run: |
          echo "ğŸ—ï¸ Construyendo aplicaciÃ³n..."
          npm run build
          
          echo "ğŸ“Š InformaciÃ³n del build:"
          du -sh build/
          ls -la build/
          
          # Verificar archivos crÃ­ticos
          if [ ! -f "build/index.html" ]; then
            echo "âŒ Error: index.html no encontrado"
            exit 1
          fi
          
          echo "âœ… Build completado exitosamente"
      
      - name: ğŸ“¤ Subir artefactos de build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ needs.prepare.outputs.environment }}
          path: frontend/build/
          retention-days: 7

  # =============================================================================
  # Job de Despliegue
  # =============================================================================
  deploy:
    name: ğŸš€ Desplegar a AWS
    runs-on: ubuntu-latest
    needs: [prepare, build-and-test]
    if: needs.prepare.outputs.should_deploy == 'true' && (github.event.inputs.action != 'destroy' || github.event.inputs.action == null)
    environment: ${{ needs.prepare.outputs.environment }}
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ“¤ Descargar artefactos de build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ needs.prepare.outputs.environment }}
          path: frontend/build/
      
      - name: âš™ï¸ Configurar AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: âœ… Verificar conexiÃ³n AWS
        run: |
          echo "ğŸ” Verificando conexiÃ³n a AWS..."
          aws sts get-caller-identity
          echo "ğŸŒ RegiÃ³n activa: $(aws configure get region)"
      
      - name: ğŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest
          terraform_wrapper: false
      
      - name: ğŸ—ï¸ Inicializar Terraform
        working-directory: ./terraform/frontend-only/environments/${{ needs.prepare.outputs.environment }}
        run: |
          echo "ğŸ”§ Inicializando Terraform FRONTEND-ONLY para ambiente: ${{ needs.prepare.outputs.environment }}"
          echo "ğŸ“ Estado se guardarÃ¡ en: frontend-only/${{ needs.prepare.outputs.environment }}/terraform.tfstate"
          echo "ğŸ›¡ï¸ Completamente separado del backend"
          
          terraform init \
            -backend-config="bucket=${{ secrets.TERRAFORM_STATE_BUCKET }}" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="encrypt=true"
      
      - name: ğŸ“‹ Planificar cambios de infraestructura
        working-directory: ./terraform/frontend-only/environments/${{ needs.prepare.outputs.environment }}
        run: |
          echo "ğŸ“‹ Ejecutando terraform plan para FRONTEND-ONLY ${{ needs.prepare.outputs.environment }}..."
          echo "ğŸ” Verificando que solo afecte recursos del frontend..."
          
          # Crear plan y guardarlo
          terraform plan -out=tfplan
          
          # Mostrar resumen de cambios
          echo "ğŸ“Š Resumen de cambios planeados:"
          terraform show -no-color tfplan | head -30
          
          echo ""
          echo "ğŸ›¡ï¸ Verificando que SOLO se crean recursos de frontend..."
          echo "âœ… Recursos esperados:"
          echo "  - S3 Bucket: finance-tracker-frontend-${{ needs.prepare.outputs.environment }}-{random}"
          echo "  - CloudFront Distribution" 
          echo "  - S3 Bucket Policy para frontend"
          echo "  - CloudFront Origin Access Control"
          echo ""
          echo "âŒ NO debe tocar:"
          echo "  - DynamoDB tables del backend"
          echo "  - Lambda functions del backend" 
          echo "  - API Gateway del backend"
          echo "  - S3 deployment-assets del backend"
      
      - name: ğŸš€ Desplegar infraestructura
        working-directory: ./terraform/frontend-only/environments/${{ needs.prepare.outputs.environment }}
        run: |
          echo "ğŸš€ Aplicando cambios de infraestructura FRONTEND-ONLY para ${{ needs.prepare.outputs.environment }}..."
          echo "âš ï¸  SOLO afectarÃ¡ recursos del frontend en el ambiente ${{ needs.prepare.outputs.environment }}"
          echo "ğŸ›¡ï¸ El backend permanece intacto"
          
          terraform apply -auto-approve tfplan
          
          echo "âœ… Infraestructura de frontend desplegada correctamente"
      
      - name: ğŸ“Š Obtener informaciÃ³n de infraestructura S3
        id: infra
        working-directory: ./terraform/frontend-only/environments/${{ needs.prepare.outputs.environment }}
        run: |
          echo "ğŸ“‹ Obteniendo informaciÃ³n de la infraestructura S3 en MÃ©xico..."
          
          # Obtener outputs de la nueva configuraciÃ³n S3-only
          S3_BUCKET=$(terraform output -raw bucket_name)
          WEBSITE_ENDPOINT=$(terraform output -raw website_endpoint)
          WEBSITE_URL=$(terraform output -raw website_url)
          
          echo "s3_bucket=$S3_BUCKET" >> $GITHUB_OUTPUT
          echo "website_endpoint=$WEBSITE_ENDPOINT" >> $GITHUB_OUTPUT
          echo "website_url=$WEBSITE_URL" >> $GITHUB_OUTPUT
          
          echo "âœ… InformaciÃ³n obtenida del S3 Website Hosting (MÃ©xico):"
          echo "  ğŸ“¦ S3 Bucket: $S3_BUCKET"
          echo "  ğŸŒ Website Endpoint: $WEBSITE_ENDPOINT"
          echo "  ğŸ”— Website URL: $WEBSITE_URL"
          echo "  ğŸ‡²ğŸ‡½ RegiÃ³n: mx-central-1"
          
          # Obtener configuraciÃ³n de Cloudflare (informativo)
          echo "ğŸ“‹ ConfiguraciÃ³n para Cloudflare:"
          terraform output cloudflare_configuration
      
      - name: ğŸ“ Configurar variables de entorno para build
        working-directory: ./frontend
        run: |
          echo "ğŸ“ Configurando .env.production para S3 Website Hosting..."
          cat > .env.production << EOF
          REACT_APP_API_URL=https://jjb0khkiz0.execute-api.mx-central-1.amazonaws.com/dev
          REACT_APP_ENVIRONMENT=${{ needs.prepare.outputs.environment }}
          REACT_APP_FRONTEND_URL=${{ steps.infra.outputs.website_url }}
          REACT_APP_REGION=mx-central-1
          REACT_APP_COUNTRY=Mexico
          REACT_APP_LOCALE=es-MX
          REACT_APP_CURRENCY=MXN
          REACT_APP_TIMEZONE=America/Mexico_City
          GENERATE_SOURCEMAP=false
          PUBLIC_URL=/
          EOF
          
          echo "âœ… Variables configuradas para MÃ©xico:"
          cat .env.production
      
      - name: â˜ï¸ Sincronizar con S3
        run: |
          echo "â˜ï¸ Subiendo archivos a S3..."
          
          # Sincronizar archivos estÃ¡ticos con cachÃ© largo (CSS, JS, imÃ¡genes)
          aws s3 sync frontend/build/ s3://${{ steps.infra.outputs.s3_bucket }}/ \
            --delete \
            --exact-timestamps \
            --metadata-directive REPLACE \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html" \
            --exclude "*.json"
            
          # Subir archivos HTML y JSON con cachÃ© corto
          aws s3 sync frontend/build/ s3://${{ steps.infra.outputs.s3_bucket }}/ \
            --exclude "*" \
            --include "*.html" \
            --include "*.json" \
            --metadata-directive REPLACE \
            --cache-control "public, max-age=0, must-revalidate"
          
          echo "âœ… Archivos subidos exitosamente a S3 MÃ©xico"
      
      - name: âœ… Verificar despliegue S3 Website
        id: verify
        run: |
          echo "ï¿½ Verificando que el S3 website estÃ© funcionando..."
          
          # Verificar que el bucket tenga hosting web habilitado
          aws s3api get-bucket-website --bucket ${{ steps.infra.outputs.s3_bucket }}
          
          echo "âœ… S3 Website Hosting configurado correctamente"
          echo "ğŸŒ Endpoint: ${{ steps.infra.outputs.website_endpoint }}"
          
      - name: ğŸ“‹ Mostrar instrucciones de Cloudflare
        run: |
          echo "ğŸ¯ PRÃ“XIMOS PASOS PARA CLOUDFLARE:"
          echo "=================================="
          echo ""
          echo "1. Ir a Cloudflare Dashboard â†’ brxvn.xyz â†’ DNS"
          echo "2. Crear registro CNAME:"
          echo "   Nombre: finance-tracker"
          echo "   Destino: ${{ steps.infra.outputs.website_endpoint }}"
          echo "3. Activar Cloudflare Proxy (nube naranja) = ON"
          echo "4. En SSL/TLS: Configurar modo 'Flexible'"
          echo "5. Esperar propagaciÃ³n DNS (5-10 minutos)"
          echo "6. Visitar https://finance-tracker.brxvn.xyz"
          echo ""
          echo "ğŸ‡²ğŸ‡½ Tu aplicaciÃ³n estÃ¡ desplegada en MÃ©xico Central (mx-central-1)"
      
      - name: ğŸ§ª Verificar despliegue S3 Website
        run: |
          echo "ğŸ§ª Verificando despliegue S3 Website..."
          
          # Esperar un poco para propagaciÃ³n
          sleep 15
          
          # Verificar que el sitio responde
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.infra.outputs.website_url }}" || echo "000")
          
          if [[ "$HTTP_STATUS" == "200" ]]; then
            echo "âœ… S3 Website respondiendo correctamente (HTTP $HTTP_STATUS)"
          else
            echo "âš ï¸ S3 Website respondiÃ³ con HTTP $HTTP_STATUS"
            echo "ğŸ’¡ Esto es normal - S3 necesita unos minutos para activar el website hosting"
          fi
      
      - name: ğŸ“Š Mostrar resumen del despliegue
        run: |
          echo "ğŸ‰ Â¡DESPLIEGUE S3 WEBSITE COMPLETADO! ğŸ‡²ğŸ‡½"
          echo "========================================"
          echo ""
          echo "ğŸ“Š InformaciÃ³n del Despliegue:"
          echo "ğŸ·ï¸  Ambiente: ${{ needs.prepare.outputs.environment }}"
          echo "ï¿½ğŸ‡½ RegiÃ³n: mx-central-1 (MÃ©xico Central)"
          echo "ğŸŒ S3 Website URL: ${{ steps.infra.outputs.website_url }}"
          echo "ğŸ“¦ S3 Bucket: ${{ steps.infra.outputs.s3_bucket }}"
          echo "ğŸŒ Website Endpoint: ${{ steps.infra.outputs.website_endpoint }}"
          echo ""
          echo "ğŸ”— Links Ãštiles:"
          echo "â€¢ S3 Website: ${{ steps.infra.outputs.website_url }}"
          echo "â€¢ S3 Console: https://s3.console.aws.amazon.com/s3/buckets/${{ steps.infra.outputs.s3_bucket }}"
          echo "â€¢ S3 Website Config: https://console.aws.amazon.com/s3/buckets/${{ steps.infra.outputs.s3_bucket }}?tab=properties&section=website"
          echo ""
          echo "ğŸ“‹ PRÃ“XIMOS PASOS PARA CLOUDFLARE:"
          echo "1. Crear CNAME: finance-tracker â†’ ${{ steps.infra.outputs.website_endpoint }}"
          echo "2. Activar Proxy Cloudflare (nube naranja)"
          echo "3. SSL/TLS modo 'Flexible'"
          echo "4. Acceder a: https://finance-tracker.brxvn.xyz"

  # =============================================================================
  # Job de Notificaciones (opcional)
  # =============================================================================
  notify:
    name: ğŸ“¢ Notificar Resultado
    runs-on: ubuntu-latest
    needs: [prepare, build-and-test, deploy]
    if: always() && needs.prepare.outputs.should_deploy == 'true' && (github.event.inputs.action != 'destroy' || github.event.inputs.action == null)
    
    steps:
      - name: ğŸ“¢ Resultado del despliegue
        run: |
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "ğŸ‰ Â¡Despliegue exitoso!"
            echo "estado=success" >> $GITHUB_ENV
            echo "emoji=ğŸ‰" >> $GITHUB_ENV
            echo "mensaje=Despliegue completado exitosamente" >> $GITHUB_ENV
          else
            echo "âŒ Despliegue fallÃ³"
            echo "estado=failure" >> $GITHUB_ENV
            echo "emoji=âŒ" >> $GITHUB_ENV  
            echo "mensaje=El despliegue fallÃ³" >> $GITHUB_ENV
          fi
          
          echo "ğŸ“Š Resumen de Jobs:"
          echo "â€¢ PreparaciÃ³n: ${{ needs.prepare.result }}"
          echo "â€¢ Build y Test: ${{ needs.build-and-test.result }}"
          echo "â€¢ Despliegue: ${{ needs.deploy.result }}"
      
      # AquÃ­ puedes agregar integraciones con Slack, Discord, etc.
      - name: ğŸ’¬ Comentar en PR (si aplica)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const estado = process.env.estado;
            const emoji = process.env.emoji;
            const mensaje = process.env.mensaje;
            
            const comment = `${emoji} **Frontend Deploy - ${estado.toUpperCase()}**
            
            **Ambiente:** ${{ needs.prepare.outputs.environment }}
            **Estado:** ${mensaje}
            
            ${estado === 'success' ? 'ğŸ”— **Links:**' : ''}
            ${estado === 'success' ? 'â€¢ [Ver Frontend](URL_WILL_BE_ADDED)' : ''}
            ${estado === 'success' ? 'â€¢ [Ver API](URL_WILL_BE_ADDED)' : ''}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # =============================================================================
  # Job de DestrucciÃ³n de Infraestructura
  # =============================================================================
  destroy:
    name: ğŸ—‘ï¸ Destruir Frontend
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy == 'DESTROY'
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: âš ï¸ Verificar confirmaciÃ³n de destrucciÃ³n
        run: |
          if [[ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]]; then
            echo "âŒ ERROR: Para destruir la infraestructura debes escribir 'DESTROY' en el campo de confirmaciÃ³n"
            echo "ğŸ›¡ï¸ Esto es una medida de seguridad para evitar destrucciones accidentales"
            exit 1
          fi
          echo "âœ… ConfirmaciÃ³n de destrucciÃ³n verificada"
          echo "âš ï¸ INICIANDO DESTRUCCIÃ“N DE INFRAESTRUCTURA DEL FRONTEND"
          echo "ğŸ¯ Ambiente: ${{ github.event.inputs.environment }}"
      
      - name: âš™ï¸ Configurar AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.12.2
          terraform_wrapper: false
      
      - name: ğŸ“‚ Navegar a directorio de Terraform
        working-directory: ./terraform/frontend-only/environments/${{ github.event.inputs.environment }}
        run: |
          echo "ğŸ“‚ Trabajando en directorio: $(pwd)"
          ls -la
      
      - name: âš™ï¸ Inicializar Terraform
        working-directory: ./terraform/frontend-only/environments/${{ github.event.inputs.environment }}
        run: |
          echo "ğŸ”§ Inicializando Terraform..."
          terraform init
      
      - name: ğŸ“‹ Mostrar plan de destrucciÃ³n
        working-directory: ./terraform/frontend-only/environments/${{ github.event.inputs.environment }}
        run: |
          echo "ğŸ“‹ Generando plan de destrucciÃ³n..."
          terraform plan -destroy -detailed-exitcode
          
          echo ""
          echo "âš ï¸ RECURSOS QUE SERÃN DESTRUIDOS:"
          echo "=================================="
          terraform show -json | jq -r '.values.root_module.resources[]? | select(.type == "aws_s3_bucket") | "ğŸ—‘ï¸ S3 Bucket: " + .values.bucket'
          terraform show -json | jq -r '.values.root_module.resources[]? | select(.type == "aws_s3_object") | "ğŸ—‘ï¸ S3 Object: " + .values.key'
      
      - name: ğŸ—‘ï¸ Destruir infraestructura
        working-directory: ./terraform/frontend-only/environments/${{ github.event.inputs.environment }}
        run: |
          echo "ğŸ—‘ï¸ INICIANDO DESTRUCCIÃ“N..."
          echo "âš ï¸ Esto eliminarÃ¡ PERMANENTEMENTE toda la infraestructura del frontend"
          echo ""
          
          # Mostrar quÃ© se va a destruir
          terraform destroy -auto-approve
          
          echo ""
          echo "âœ… DESTRUCCIÃ“N COMPLETADA"
          echo "========================="
          echo "ğŸ—‘ï¸ Toda la infraestructura del frontend ha sido eliminada"
          echo "ğŸ’° Esto evitarÃ¡ costos futuros de AWS"
          echo "âš ï¸ Para volver a desplegar, ejecuta este workflow con acciÃ³n 'deploy'"
      
      - name: ğŸ“Š Resumen de destrucciÃ³n
        run: |
          echo "ğŸ“Š RESUMEN DE DESTRUCCIÃ“N"
          echo "========================="
          echo ""
          echo "âœ… Recursos eliminados:"
          echo "  ğŸ—‘ï¸ S3 Bucket: finance-tracker.brxvn.xyz"
          echo "  ğŸ—‘ï¸ S3 Website Configuration"
          echo "  ğŸ—‘ï¸ S3 Bucket Policy"
          echo "  ğŸ—‘ï¸ S3 CORS Configuration"
          echo "  ğŸ—‘ï¸ Archivos de configuraciÃ³n"
          echo ""
          echo "ğŸ“‹ PrÃ³ximos pasos:"
          echo "  1. âš ï¸ El dominio finance-tracker.brxvn.xyz ya no funcionarÃ¡"
          echo "  2. ğŸ”§ Puedes eliminar el CNAME de Cloudflare si quieres"
          echo "  3. ğŸš€ Para volver a desplegar, ejecuta este workflow con 'deploy'"
          echo ""
          echo "ğŸ’¡ Nota: Esta acciÃ³n es IRREVERSIBLE"

  # =============================================================================
  # Job de VerificaciÃ³n de AcciÃ³n No VÃ¡lida
  # =============================================================================
  invalid_destroy:
    name: âŒ DestrucciÃ³n No Confirmada
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy != 'DESTROY'
    
    steps:
      - name: âŒ Error de confirmaciÃ³n
        run: |
          echo "âŒ ERROR: DESTRUCCIÃ“N NO CONFIRMADA"
          echo "=================================="
          echo ""
          echo "ğŸ›¡ï¸ Para destruir la infraestructura debes:"
          echo "  1. Seleccionar acciÃ³n 'destroy'"
          echo "  2. Escribir exactamente 'DESTROY' en el campo de confirmaciÃ³n"
          echo ""
          echo "âš ï¸ Esto es una medida de seguridad para evitar eliminaciones accidentales"
          echo "ğŸ’¡ Si realmente quieres destruir la infraestructura, vuelve a ejecutar el workflow"
          exit 1
