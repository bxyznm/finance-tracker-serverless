# =============================================================================
# Workflow Simple para Despliegue de Frontend
# =============================================================================
# Version simplificada que usa AWS credentials bÃ¡sicas

name: Simple Frontend Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente de despliegue'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

env:
  AWS_REGION: mx-central-1
  NODE_VERSION: '18'

jobs:
  deploy:
    name: ğŸš€ Build y Deploy Frontend
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
      
      - name: âš™ï¸ Configurar AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ğŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest
          terraform_wrapper: false
      
      - name: ğŸ“Š Obtener informaciÃ³n de infraestructura
        id: infra
        working-directory: ./terraform/environments/${{ inputs.environment }}
        run: |
          echo "ğŸ“‹ Inicializando Terraform..."
          terraform init
          
          echo "ğŸ“Š Obteniendo outputs..."
          S3_BUCKET=$(terraform output -raw frontend_bucket_name)
          CLOUDFRONT_ID=$(terraform output -raw frontend_cloudfront_distribution_id)
          API_URL=$(terraform output -raw api_gateway_url)
          FRONTEND_URL=$(terraform output -raw frontend_url)
          
          echo "s3_bucket=$S3_BUCKET" >> $GITHUB_OUTPUT
          echo "cloudfront_id=$CLOUDFRONT_ID" >> $GITHUB_OUTPUT
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          
          echo "âœ… Infraestructura encontrada:"
          echo "  ğŸ“¦ S3: $S3_BUCKET"
          echo "  ğŸ“¡ CloudFront: $CLOUDFRONT_ID"
          echo "  ğŸŒ Frontend: $FRONTEND_URL"
          echo "  ğŸ”— API: $API_URL"
      
      - name: ğŸ“¦ Instalar dependencias
        working-directory: ./frontend
        run: |
          echo "ğŸ“¦ Instalando dependencias..."
          npm ci
      
      - name: ğŸ§ª Ejecutar tests
        working-directory: ./frontend
        run: |
          echo "ğŸ§ª Ejecutando tests..."
          npm test -- --watchAll=false --passWithNoTests
      
      - name: ğŸ“ Configurar variables de entorno
        working-directory: ./frontend
        run: |
          echo "ğŸ“ Configurando variables de entorno..."
          cat > .env.production << EOF
          REACT_APP_API_URL=${{ steps.infra.outputs.api_url }}
          REACT_APP_ENVIRONMENT=${{ inputs.environment }}
          REACT_APP_FRONTEND_URL=${{ steps.infra.outputs.frontend_url }}
          GENERATE_SOURCEMAP=false
          PUBLIC_URL=/
          EOF
          
          echo "âœ… Variables configuradas"
      
      - name: ğŸ—ï¸ Build aplicaciÃ³n
        working-directory: ./frontend
        env:
          CI: true
        run: |
          echo "ğŸ—ï¸ Construyendo aplicaciÃ³n..."
          npm run build
          
          echo "ğŸ“Š TamaÃ±o del build:"
          du -sh build/
          
          echo "âœ… Build completado"
      
      - name: â˜ï¸ Deploy a S3
        run: |
          echo "â˜ï¸ Subiendo a S3..."
          
          # Subir archivos estÃ¡ticos con cache largo
          aws s3 sync frontend/build/ s3://${{ steps.infra.outputs.s3_bucket }}/ \
            --delete \
            --cache-control "public,max-age=31536000,immutable" \
            --exclude "*.html" \
            --exclude "*.json"
          
          # Subir HTML/JSON con cache corto
          aws s3 sync frontend/build/ s3://${{ steps.infra.outputs.s3_bucket }}/ \
            --exclude "*" \
            --include "*.html" \
            --include "*.json" \
            --cache-control "public,max-age=0,must-revalidate"
          
          echo "âœ… Archivos subidos a S3"
      
      - name: ğŸ”„ Invalidar CloudFront
        id: invalidation
        run: |
          echo "ğŸ”„ Invalidando CloudFront..."
          
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ steps.infra.outputs.cloudfront_id }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          
          echo "invalidation_id=$INVALIDATION_ID" >> $GITHUB_OUTPUT
          echo "âœ… InvalidaciÃ³n iniciada: $INVALIDATION_ID"
      
      - name: ğŸ§ª Verificar despliegue
        run: |
          echo "ğŸ§ª Verificando despliegue..."
          sleep 30
          
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.infra.outputs.frontend_url }}" || echo "000")
          
          if [[ "$HTTP_STATUS" == "200" ]]; then
            echo "âœ… Frontend funcionando correctamente"
          else
            echo "âš ï¸ Frontend respondiÃ³ con cÃ³digo: $HTTP_STATUS"
          fi
      
      - name: ğŸ“Š Resumen
        run: |
          echo ""
          echo "ğŸ‰ Â¡DESPLIEGUE COMPLETADO!"
          echo "========================="
          echo ""
          echo "ğŸ·ï¸  Ambiente: ${{ inputs.environment }}"
          echo "ğŸŒ Frontend: ${{ steps.infra.outputs.frontend_url }}"
          echo "ğŸ”— API: ${{ steps.infra.outputs.api_url }}"
          echo "ğŸ“¦ S3: ${{ steps.infra.outputs.s3_bucket }}"
          echo "ğŸ“¡ CloudFront: ${{ steps.infra.outputs.cloudfront_id }}"
          echo "ğŸ”„ InvalidaciÃ³n: ${{ steps.invalidation.outputs.invalidation_id }}"
          echo ""
          echo "ğŸŒ Accede a tu aplicaciÃ³n en:"
          echo "${{ steps.infra.outputs.frontend_url }}"
