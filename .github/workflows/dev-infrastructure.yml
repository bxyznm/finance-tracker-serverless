# Workflow manual para desplegar solo infraestructura de desarrollo
# No crea releases, solo despliega usando un release existente
name: Dev Infrastructure Only

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Tag del release/pre-release a usar (opcional, usa el Ãºltimo pre-release si estÃ¡ vacÃ­o)'
        required: false
        type: string
      operation:
        description: 'OperaciÃ³n a realizar'
        required: true
        default: 'deploy'
        type: choice
        options:
        - deploy
        - destroy
      destroy_first:
        description: 'Destruir infraestructura existente antes de desplegar (solo para deploy)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: mx-central-1
  TERRAFORM_VERSION: "1.12.2"

jobs:
  deploy-dev-infrastructure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show deployment info
        run: |
          echo "ðŸ—ï¸ InformaciÃ³n del Deployment de Infraestructura Dev:"
          echo "   OperaciÃ³n: ${{ inputs.operation }}"
          echo "   Release Tag: ${{ inputs.release_tag || 'Ãºltimo pre-release' }}"
          echo "   Destruir primero: ${{ inputs.destroy_first }}"
          echo "   Ejecutado por: ${{ github.actor }}"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Get release tag to use
        id: get_release
        run: |
          if [ -n "${{ inputs.release_tag }}" ]; then
            RELEASE_TAG="${{ inputs.release_tag }}"
            echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Usando release tag especificado: $RELEASE_TAG"
          else
            # Obtener el Ãºltimo pre-release
            LATEST_PRERELEASE=$(gh release list --limit 1 --json tagName,isPrerelease --jq '.[] | select(.isPrerelease==true) | .tagName')
            if [ -n "$LATEST_PRERELEASE" ]; then
              echo "release_tag=$LATEST_PRERELEASE" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ Usando Ãºltimo pre-release: $LATEST_PRERELEASE"
            else
              echo "âŒ No se encontrÃ³ ningÃºn pre-release disponible"
              exit 1
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify release exists
        run: |
          RELEASE_TAG="${{ steps.get_release.outputs.release_tag }}"
          if gh release view "$RELEASE_TAG" >/dev/null 2>&1; then
            echo "âœ… Release $RELEASE_TAG existe y estÃ¡ disponible"
          else
            echo "âŒ Release $RELEASE_TAG no existe"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Ensure S3 bucket exists for terraform state
        if: inputs.operation == 'deploy'
        run: |
          BUCKET_NAME="finance-tracker-serverless-tfstates"
          
          if aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
            echo "âœ… S3 bucket $BUCKET_NAME already exists"
          else
            echo "ðŸ“¦ Creating S3 bucket $BUCKET_NAME for terraform state"
            aws s3api create-bucket --bucket "$BUCKET_NAME" --region ${{ env.AWS_REGION }} \
              --create-bucket-configuration LocationConstraint=${{ env.AWS_REGION }}
            
            aws s3api put-bucket-versioning --bucket "$BUCKET_NAME" \
              --versioning-configuration Status=Enabled
            
            aws s3api put-bucket-encryption --bucket "$BUCKET_NAME" \
              --server-side-encryption-configuration '{
                "Rules": [{
                  "ApplyServerSideEncryptionByDefault": {
                    "SSEAlgorithm": "AES256"
                  },
                  "BucketKeyEnabled": false
                }]
              }'
            
            echo "âœ… S3 bucket $BUCKET_NAME created and configured"
          fi

      - name: Terraform Init
        working-directory: terraform/environments/dev
        run: terraform init -upgrade

      - name: Destroy existing infrastructure (if requested)
        if: inputs.operation == 'deploy' && inputs.destroy_first == true
        working-directory: terraform/environments/dev
        env:
          TF_VAR_github_owner: ${{ github.repository_owner }}
          TF_VAR_github_repository: ${{ github.event.repository.name }}
          TF_VAR_github_token: ${{ secrets.GITHUB_TOKEN }}
          TF_VAR_dev_release_tag: ${{ steps.get_release.outputs.release_tag }}
        run: |
          echo "ðŸ—‘ï¸ Destruyendo infraestructura existente..."
          terraform destroy -auto-approve

      - name: Terraform Plan
        if: inputs.operation == 'deploy'
        working-directory: terraform/environments/dev
        env:
          TF_VAR_github_owner: ${{ github.repository_owner }}
          TF_VAR_github_repository: ${{ github.event.repository.name }}
          TF_VAR_github_token: ${{ secrets.GITHUB_TOKEN }}
          TF_VAR_dev_release_tag: ${{ steps.get_release.outputs.release_tag }}
        run: terraform plan -out=tfplan

      - name: Terraform Deploy
        if: inputs.operation == 'deploy'
        working-directory: terraform/environments/dev
        env:
          TF_VAR_github_owner: ${{ github.repository_owner }}
          TF_VAR_github_repository: ${{ github.event.repository.name }}
          TF_VAR_github_token: ${{ secrets.GITHUB_TOKEN }}
          TF_VAR_dev_release_tag: ${{ steps.get_release.outputs.release_tag }}
        run: |
          echo "ðŸš€ Desplegando infraestructura..."
          terraform apply -auto-approve tfplan

      - name: Terraform Destroy
        if: inputs.operation == 'destroy'
        working-directory: terraform/environments/dev
        env:
          TF_VAR_github_owner: ${{ github.repository_owner }}
          TF_VAR_github_repository: ${{ github.event.repository.name }}
          TF_VAR_github_token: ${{ secrets.GITHUB_TOKEN }}
          TF_VAR_dev_release_tag: ${{ steps.get_release.outputs.release_tag }}
        run: |
          echo "ðŸ—‘ï¸ Destruyendo infraestructura..."
          terraform destroy -auto-approve

      - name: Create deployment summary
        run: |
          echo "# ðŸ—ï¸ Finance Tracker Dev Infrastructure Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š InformaciÃ³n del Deployment" >> $GITHUB_STEP_SUMMARY
          echo "| Variable | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Fecha** | \`$(date '+%Y-%m-%d %H:%M:%S UTC')\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **OperaciÃ³n** | \`${{ inputs.operation }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Release Tag** | \`${{ steps.get_release.outputs.release_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Destruir Primero** | \`${{ inputs.destroy_first }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Ejecutado por** | \`${{ github.actor }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ—ï¸ Estado del Deployment" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.operation }}" = "deploy" ]; then
            echo "- âœ… Infraestructura desplegada exitosamente en dev" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… Infraestructura destruida exitosamente en dev" >> $GITHUB_STEP_SUMMARY
          fi
