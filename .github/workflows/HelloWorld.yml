name: CodeBuild - Build with GitHub Actions Runner

on: [push]

jobs:
  Hello-World-Job:
    runs-on:
      - codebuild-test-${{ github.run_id }}-${{ github.run_attempt }}

steps:
  - name:  Checkout c贸digo
    uses: actions/checkout@v4
  
  - name:  Setup Node.js
    uses: actions/setup-node@v4
    with:
      node-version: ${{ env.NODE_VERSION }}
      registry-url: 'https://registry.npmjs.org/'
  
  - name:  Configurar cach茅 npm
    uses: actions/cache@v4
    with:
      path: |
        ~/.npm
        frontend/node_modules
      key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('frontend/package-lock.json', 'frontend/package.json') }}
      restore-keys: |
        ${{ runner.os }}-node-${{ env.NODE_VERSION }}-
        ${{ runner.os }}-node-
  
  - name:  Mostrar informaci贸n del ambiente
    run: |
      echo " Informaci贸n del Build:"
      echo "Node.js: $(node --version)"
      echo "npm: $(npm --version)"
      echo "Ambiente: ${{ needs.prepare.outputs.environment }}"
      echo "Directorio: $(pwd)"
  
  - name:  Instalar dependencias
    working-directory: ./frontend
    run: |
      echo " Instalando dependencias..."
      echo "Node: $(node --version), npm: $(npm --version)"
      
      # Limpiar cach茅 npm si es necesario
      npm cache clean --force || true
      
      # Instalar dependencias
      if [[ -f "package-lock.json" ]]; then
        npm ci --prefer-offline --no-audit
      else
        npm install --prefer-offline --no-audit
      fi
      
      echo " Informaci贸n de dependencias:"
      npm list --depth=0 || true
  
  - name: И Ejecutar tests
    if: ${{ github.event.inputs.skip_tests != 'true' && github.event.inputs.skip_tests != true }}
    working-directory: ./frontend
    run: |
      echo "И Ejecutando tests..."
      npm test -- --coverage --watchAll=false --passWithNoTests
  
  - name:  Lint y verificaciones
    working-directory: ./frontend
    run: |
      echo " Verificando c贸digo..."
      # Si existe ESLint, ejecutarlo
      if npm list eslint &>/dev/null; then
        npm run lint --if-present || echo "锔 ESLint no configurado"
      fi
      
      # Verificar TypeScript si est谩 configurado
      if [ -f "tsconfig.json" ]; then
        echo " Verificando TypeScript..."
        npx tsc --noEmit || echo "锔 TypeScript check fall贸"
      fi